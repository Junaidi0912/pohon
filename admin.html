<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perpustakaan Abadi - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=MedievalSharp&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        parchment: '#F5E6CA',
                        oldPaper: '#E8D9B5',
                        darkBrown: '#8B4513',
                        gold: '#D4AF37',
                        silver: '#C0C0C0',
                        bronze: '#CD7F32',
                        mysticBlue: '#1E3A5F',
                        deepRed: '#8B0000',
                        forestGreen: '#228B22'
                    },
                    fontFamily: {
                        'cinzel': ['Cinzel', 'serif'],
                        'medieval': ['MedievalSharp', 'cursive'],
                        'maguntia': ['UnifrakturMaguntia', 'cursive']
                    },
                    fontSize: {
                        'xs': '0.75rem',
                        'sm': '0.875rem',
                        'base': '1rem',
                        'lg': '1.125rem',
                        'xl': '1.25rem',
                        '2xl': '1.5rem',
                        '3xl': '1.875rem',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #2C1810 0%, #1A0F0A 50%, #0F0805 100%);
        }
        
        .parchment-bg {
            background: linear-gradient(135deg, #F5E6CA 0%, #E8D9B5 50%, #DBC9A0 100%);
            border: 4px double #8B4513;
            box-shadow: 
                0 0 20px rgba(139, 69, 19, 0.3),
                inset 0 0 30px rgba(139, 69, 19, 0.1);
        }
        
        .ancient-border {
            border: 6px solid transparent;
            border-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0,0 L100,0 L100,100 L0,100 Z' fill='none' stroke='%238B4513' stroke-width='6' stroke-dasharray='15,8'/%3E%3C/svg%3E") 25 round;
        }
        
        .stats-card {
            transition: all 0.3s ease;
            border: 2px solid #8B4513;
        }
        
        .stats-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.3);
        }
        
        .student-row {
            transition: all 0.3s ease;
        }
        
        .student-row:hover {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.1), rgba(139, 69, 19, 0.1));
        }
        
        .rank-progress {
            background: linear-gradient(90deg, #D4AF37, #8B4513);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .mobile-padding {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .mobile-text-sm {
                font-size: 0.8rem;
            }
            
            .mobile-text-base {
                font-size: 0.9rem;
            }
            
            .mobile-text-lg {
                font-size: 1rem;
            }
            
            .mobile-text-xl {
                font-size: 1.1rem;
            }
            
            .mobile-text-2xl {
                font-size: 1.25rem;
            }
            
            .mobile-py-2 {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            
            .mobile-py-3 {
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
            }
            
            .mobile-px-3 {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            
            .mobile-px-4 {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        /* Custom scrollbar untuk mobile */
        .mobile-scroll {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #8B4513 #F5E6CA;
        }

        .mobile-scroll::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        .mobile-scroll::-webkit-scrollbar-track {
            background: #F5E6CA;
            border-radius: 10px;
        }

        .mobile-scroll::-webkit-scrollbar-thumb {
            background: #8B4513;
            border-radius: 10px;
        }

        /* Search highlight */
        .search-highlight {
            background-color: rgba(212, 175, 55, 0.3);
            border-radius: 2px;
            padding: 0 2px;
        }

        /* Filter buttons */
        .filter-btn {
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #D4AF37, #8B4513);
            color: white;
            border-color: #8B4513;
        }

        /* Online/Offline Status */
        .online-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }
        
        .status-online {
            background-color: #22c55e;
        }
        
        .status-offline {
            background-color: #ef4444;
        }

        .status-idle {
            background-color: #f59e0b;
        }
    </style>
</head>
<body class="font-cinzel text-oldPaper min-h-screen">
    <!-- Navigation -->
    <nav class="bg-darkBrown/90 shadow-2xl border-b-2 border-gold sticky top-0 z-40">
        <div class="container mx-auto mobile-padding py-3">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-3 sm:space-y-0">
                <div class="flex items-center space-x-3 justify-center sm:justify-start">
                    <div class="w-10 h-10 bg-gradient-to-r from-gold to-bronze rounded-full flex items-center justify-center ancient-border">
                        <i class="fas fa-user-shield text-darkBrown mobile-text-lg"></i>
                    </div>
                    <div class="text-center sm:text-left">
                        <h1 class="mobile-text-2xl font-bold text-gold font-maguntia">Perpustakaan Abadi</h1>
                        <p class="text-silver mobile-text-sm font-medieval">Panel Administrator</p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 sm:items-center">
                    <button onclick="refreshData()" class="bg-gold hover:bg-yellow-600 text-darkBrown mobile-px-4 mobile-py-2 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 border-2 border-darkBrown font-medieval mobile-text-sm flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-2"></i>Perbarui
                    </button>
                    <a href="siswa.html" class="bg-forestGreen hover:bg-green-800 text-parchment mobile-px-4 mobile-py-2 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 border-2 border-gold font-medieval mobile-text-sm flex items-center justify-center">
                        <i class="fas fa-eye mr-2"></i>Lihat Siswa
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="py-4 mobile-padding">
        <div class="container mx-auto">
            <!-- Statistics Overview -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="stats-card parchment-bg rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="mobile-text-xl font-bold text-darkBrown" id="total-students">0</div>
                            <div class="text-darkBrown font-medieval mobile-text-sm">Total Petualang</div>
                        </div>
                        <div class="w-8 h-8 bg-gold/20 rounded-full flex items-center justify-center ancient-border">
                            <i class="fas fa-users text-gold"></i>
                        </div>
                    </div>
                </div>

                <div class="stats-card parchment-bg rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="mobile-text-xl font-bold text-darkBrown" id="online-students">0</div>
                            <div class="text-darkBrown font-medieval mobile-text-sm">Online</div>
                        </div>
                        <div class="w-8 h-8 bg-forestGreen/20 rounded-full flex items-center justify-center ancient-border">
                            <i class="fas fa-wifi text-forestGreen"></i>
                        </div>
                    </div>
                </div>

                <div class="stats-card parchment-bg rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="mobile-text-xl font-bold text-darkBrown" id="total-points">0</div>
                            <div class="text-darkBrown font-medieval mobile-text-sm">Total XP</div>
                        </div>
                        <div class="w-8 h-8 bg-gold/20 rounded-full flex items-center justify-center ancient-border">
                            <i class="fas fa-star text-gold"></i>
                        </div>
                    </div>
                </div>

                <div class="stats-card parchment-bg rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="mobile-text-xl font-bold text-darkBrown" id="avg-points">0</div>
                            <div class="text-darkBrown font-medieval mobile-text-sm">Rata-rata XP</div>
                        </div>
                        <div class="w-8 h-8 bg-bronze/20 rounded-full flex items-center justify-center ancient-border">
                            <i class="fas fa-chart-line text-bronze"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="parchment-bg rounded-xl p-4 ancient-border mb-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-3 md:space-y-0">
                    <div class="flex-1">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="search-input"
                                placeholder="Cari nama petualang..."
                                class="w-full mobile-px-4 mobile-py-2 bg-oldPaper border-2 border-darkBrown rounded-lg focus:border-gold focus:ring-2 focus:ring-gold/30 transition-all duration-300 outline-none font-medieval mobile-text-sm pr-10"
                            >
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-darkBrown">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="adminSystem.clearSearch()" class="bg-silver hover:bg-gray-500 text-darkBrown mobile-px-3 mobile-py-2 rounded-lg font-semibold transition-all duration-300 border-2 border-darkBrown font-medieval mobile-text-sm">
                            <i class="fas fa-times mr-1"></i>Clear
                        </button>
                        <button onclick="adminSystem.toggleSort()" class="bg-mysticBlue hover:bg-blue-800 text-parchment mobile-px-3 mobile-py-2 rounded-lg font-semibold transition-all duration-300 border-2 border-gold font-medieval mobile-text-sm">
                            <i class="fas fa-sort-amount-down mr-1" id="sort-icon"></i>
                            <span id="sort-text">XP Tertinggi</span>
                        </button>
                    </div>
                </div>

                <!-- Filter by Class -->
                <div class="mt-3">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="adminSystem.filterByClass('')" class="filter-btn active bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Semua Kelas
                        </button>
                        <button onclick="adminSystem.filterByClass('7A')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Kelas 7A
                        </button>
                        <button onclick="adminSystem.filterByClass('7B')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Kelas 7B
                        </button>
                        <button onclick="adminSystem.filterByClass('7C')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Kelas 7C
                        </button>
                        <button onclick="adminSystem.filterByClass('8A')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Kelas 8A
                        </button>
                        <button onclick="adminSystem.filterByClass('8B')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Kelas 8B
                        </button>
                        <button onclick="adminSystem.filterByClass('8C')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Kelas 8C
                        </button>
                        <button onclick="adminSystem.filterByClass('9A')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Kelas 9A
                        </button>
                        <button onclick="adminSystem.filterByClass('9B')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Kelas 9B
                        </button>
                        <button onclick="adminSystem.filterByClass('9C')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Kelas 9C
                        </button>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="mt-3">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="adminSystem.filterByStatus('all')" class="filter-btn active bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            Semua Status
                        </button>
                        <button onclick="adminSystem.filterByStatus('online')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            <span class="online-status status-online"></span>Online
                        </button>
                        <button onclick="adminSystem.filterByStatus('offline')" class="filter-btn bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown font-medieval">
                            <span class="online-status status-offline"></span>Offline
                        </button>
                    </div>
                </div>

                <!-- Search Results Info -->
                <div id="search-info" class="mt-2 text-darkBrown font-medieval mobile-text-sm hidden">
                    Menampilkan <span id="result-count">0</span> dari <span id="total-count">0</span> petualang
                    <span id="search-term-display" class="font-semibold"></span>
                </div>
            </div>

            <!-- Students List -->
            <div class="parchment-bg rounded-xl overflow-hidden ancient-border mb-6">
                <div class="mobile-px-4 mobile-py-3 border-b-2 border-darkBrown flex justify-between items-center">
                    <div>
                        <h3 class="mobile-text-xl font-bold text-darkBrown font-maguntia">Daftar Petualang</h3>
                        <p class="text-darkBrown font-medieval mobile-text-sm">Kelola XP dan pantau progress</p>
                    </div>
                    <div id="student-count" class="bg-gold/20 text-darkBrown mobile-px-3 mobile-py-1 rounded-full text-xs font-semibold border border-darkBrown">
                        0 petualang
                    </div>
                </div>

                <div class="overflow-x-auto mobile-scroll">
                    <table class="w-full min-w-[600px]">
                        <thead>
                            <tr class="bg-oldPaper">
                                <th class="mobile-px-3 mobile-py-3 text-left font-semibold text-darkBrown font-medieval mobile-text-sm">Nama</th>
                                <th class="mobile-px-3 mobile-py-3 text-left font-semibold text-darkBrown font-medieval mobile-text-sm">Kelas</th>
                                <th class="mobile-px-3 mobile-py-3 text-left font-semibold text-darkBrown font-medieval mobile-text-sm">XP</th>
                                <th class="mobile-px-3 mobile-py-3 text-left font-semibold text-darkBrown font-medieval mobile-text-sm">Rank</th>
                                <th class="mobile-px-3 mobile-py-3 text-left font-semibold text-darkBrown font-medieval mobile-text-sm">Status</th>
                                <th class="mobile-px-3 mobile-py-3 text-left font-semibold text-darkBrown font-medieval mobile-text-sm">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            <!-- Data siswa akan diisi di sini -->
                        </tbody>
                    </table>
                </div>

                <div class="mobile-px-4 mobile-py-6 border-t-2 border-darkBrown text-center text-darkBrown font-medieval" id="empty-state">
                    <i class="fas fa-scroll text-4xl mb-3 opacity-50"></i>
                    <p class="mobile-text-lg">Belum ada petualang</p>
                    <p class="mobile-text-sm mt-1">Arahkan siswa untuk login</p>
                </div>

                <div class="mobile-px-4 mobile-py-6 border-t-2 border-darkBrown text-center text-darkBrown font-medieval hidden" id="no-results-state">
                    <i class="fas fa-search text-4xl mb-3 opacity-50"></i>
                    <p class="mobile-text-lg">Tidak ditemukan</p>
                    <p class="mobile-text-sm mt-1">Coba dengan kata kunci lain</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="parchment-bg rounded-xl p-4 ancient-border">
                <h3 class="mobile-text-xl font-bold text-darkBrown font-maguntia mb-3">Tambah XP Cepat</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="showBulkAddModal(5)" class="parchment-bg hover:bg-gold/20 text-darkBrown mobile-py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 border-2 border-darkBrown font-medieval mobile-text-sm flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i>+5 XP
                    </button>
                    <button onclick="showBulkAddModal(15)" class="parchment-bg hover:bg-gold/20 text-darkBrown mobile-py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 border-2 border-darkBrown font-medieval mobile-text-sm flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i>+15 XP
                    </button>
                    <button onclick="showBulkAddModal(20)" class="parchment-bg hover:bg-gold/20 text-darkBrown mobile-py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 border-2 border-darkBrown font-medieval mobile-text-sm flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i>+20 XP
                    </button>
                    <button onclick="showBulkAddModal(30)" class="parchment-bg hover:bg-gold/20 text-darkBrown mobile-py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 border-2 border-darkBrown font-medieval mobile-text-sm flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i>+30 XP
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Points Modal -->
    <div id="add-points-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center mobile-padding backdrop-blur-sm">
        <div class="parchment-bg rounded-xl p-5 w-full max-w-sm ancient-border">
            <h4 class="mobile-text-xl font-bold text-darkBrown font-maguntia mb-3">Tambah XP</h4>
            <div class="space-y-4">
                <div>
                    <label class="block text-darkBrown font-semibold mb-2 font-medieval mobile-text-sm">Jumlah XP</label>
                    <input type="number" id="points-amount" 
                           class="w-full mobile-px-3 mobile-py-2 bg-oldPaper border-2 border-darkBrown rounded-lg focus:border-gold focus:ring-2 focus:ring-gold/30 transition-all duration-300 outline-none font-medieval mobile-text-sm"
                           min="1" max="100" value="5">
                </div>
                <div class="flex space-x-2">
                    <button onclick="addPointsToStudent()" class="flex-1 bg-gold hover:bg-yellow-600 text-darkBrown mobile-py-2 rounded-lg font-semibold transition-all duration-300 border-2 border-darkBrown font-medieval mobile-text-sm">
                        Tambah XP
                    </button>
                    <button onclick="closeAddPointsModal()" class="flex-1 bg-deepRed hover:bg-red-800 text-parchment mobile-py-2 rounded-lg font-semibold transition-all duration-300 border-2 border-gold font-medieval mobile-text-sm">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Add Modal -->
    <div id="bulk-add-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center mobile-padding backdrop-blur-sm">
        <div class="parchment-bg rounded-xl p-5 w-full max-w-sm ancient-border">
            <h4 class="mobile-text-xl font-bold text-darkBrown font-maguntia mb-3">Tambah XP ke Semua</h4>
            <div class="space-y-4">
                <div>
                    <label class="block text-darkBrown font-semibold mb-2 font-medieval mobile-text-sm">Jumlah XP</label>
                    <div class="mobile-text-2xl font-bold text-gold text-center" id="bulk-points-amount">5</div>
                </div>
                <div class="text-center text-darkBrown font-medieval mobile-text-sm">
                    XP akan ditambahkan ke semua petualang aktif
                </div>
                <div class="flex space-x-2">
                    <button onclick="addPointsToAllStudents()" class="flex-1 bg-gold hover:bg-yellow-600 text-darkBrown mobile-py-2 rounded-lg font-semibold transition-all duration-300 border-2 border-darkBrown font-medieval mobile-text-sm">
                        Tambah Semua
                    </button>
                    <button onclick="closeBulkAddModal()" class="flex-1 bg-deepRed hover:bg-red-800 text-parchment mobile-py-2 rounded-lg font-semibold transition-all duration-300 border-2 border-gold font-medieval mobile-text-sm">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdminSystem {
            constructor() {
                this.students = [];
                this.filteredStudents = [];
                this.selectedStudentId = null;
                this.bulkPoints = 0;
                this.searchTerm = '';
                this.selectedClass = '';
                this.selectedStatus = 'all';
                this.sortDescending = true;
                this.init();
            }

            init() {
                this.loadStudents();
                this.setupEventListeners();
                this.startAutoRefresh();
            }

            loadStudents() {
                // FIXED: Gunakan SATU sumber data utama
                const studentData = JSON.parse(localStorage.getItem('perpustakaan_abadi_students') || '[]');
                
                // Update status online/offline berdasarkan lastActivity
                const updatedStudents = studentData.map(student => {
                    const lastActivity = new Date(student.lastActivity || student.lastLogin);
                    const now = new Date();
                    const minutesSinceLastActivity = (now - lastActivity) / (1000 * 60);
                    
                    // Jika lebih dari 5 menit tidak aktif, anggap offline
                    student.isOnline = minutesSinceLastActivity < 5;
                    
                    return student;
                });

                this.students = updatedStudents;
                this.applyFilters();
            }

            setupEventListeners() {
                // Search input event
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.searchTerm = e.target.value.toLowerCase().trim();
                    this.applyFilters();
                });

                // Auto-refresh setiap 3 detik untuk data real-time
                setInterval(() => {
                    this.loadStudents();
                }, 3000);
            }

            startAutoRefresh() {
                setInterval(() => {
                    this.loadStudents();
                }, 3000);
            }

            applyFilters() {
                let filtered = [...this.students];

                // Apply search filter
                if (this.searchTerm) {
                    filtered = filtered.filter(student => 
                        student.name.toLowerCase().includes(this.searchTerm) ||
                        student.class.toLowerCase().includes(this.searchTerm)
                    );
                }

                // Apply class filter
                if (this.selectedClass) {
                    filtered = filtered.filter(student => student.class === this.selectedClass);
                }

                // Apply status filter
                if (this.selectedStatus !== 'all') {
                    filtered = filtered.filter(student => {
                        if (this.selectedStatus === 'online') return student.isOnline === true;
                        if (this.selectedStatus === 'offline') return student.isOnline === false;
                        return true;
                    });
                }

                // Apply sorting
                filtered.sort((a, b) => {
                    if (this.sortDescending) {
                        return b.points - a.points;
                    } else {
                        return a.points - b.points;
                    }
                });

                this.filteredStudents = filtered;
                this.updateDisplay();
            }

            updateDisplay() {
                this.updateStatistics();
                this.updateStudentsTable();
                this.updateSearchInfo();
            }

            updateStatistics() {
                const totalStudents = this.students.length;
                const onlineStudents = this.students.filter(s => s.isOnline).length;
                const totalPoints = this.students.reduce((sum, student) => sum + student.points, 0);
                const avgPoints = totalStudents > 0 ? Math.round(totalPoints / totalStudents) : 0;

                document.getElementById('total-students').textContent = totalStudents;
                document.getElementById('online-students').textContent = onlineStudents;
                document.getElementById('total-points').textContent = totalPoints;
                document.getElementById('avg-points').textContent = avgPoints;
            }

            updateStudentsTable() {
                const tbody = document.getElementById('students-table-body');
                const emptyState = document.getElementById('empty-state');
                const noResultsState = document.getElementById('no-results-state');
                const studentCount = document.getElementById('student-count');

                studentCount.textContent = `${this.filteredStudents.length} petualang`;

                if (this.students.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    noResultsState.classList.add('hidden');
                    return;
                }

                if (this.filteredStudents.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.classList.add('hidden');
                    noResultsState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                noResultsState.classList.add('hidden');

                tbody.innerHTML = this.filteredStudents.map(student => `
                    <tr class="student-row border-b border-darkBrown hover:bg-gold/10">
                        <td class="mobile-px-3 mobile-py-2">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-gradient-to-r from-gold to-bronze rounded-full flex items-center justify-center text-darkBrown font-semibold ancient-border mobile-text-sm">
                                    <i class="fas fa-${student.profileIcon || 'book-reader'}"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-darkBrown mobile-text-sm">
                                        ${this.highlightSearchTerm(student.name)}
                                    </div>
                                    <div class="text-darkBrown font-medieval mobile-text-xs">ID: ${student.id.slice(-4)}</div>
                                </div>
                            </div>
                        </td>
                        <td class="mobile-px-3 mobile-py-2">
                            <span class="bg-gold/20 text-darkBrown mobile-px-2 mobile-py-1 rounded-full mobile-text-xs font-semibold font-medieval border border-darkBrown">
                                ${student.class}
                            </span>
                        </td>
                        <td class="mobile-px-3 mobile-py-2">
                            <div class="flex flex-col space-y-1">
                                <span class="font-bold text-darkBrown mobile-text-sm">${student.points}</span>
                                <div class="w-20 bg-darkBrown rounded-full h-2">
                                    <div class="rank-progress h-2 rounded-full transition-all duration-1000" 
                                         style="width: ${Math.min(100, (student.points / 1000) * 100)}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="mobile-px-3 mobile-py-2">
                            <span class="mobile-px-2 mobile-py-1 rounded mobile-text-xs font-semibold border border-darkBrown ${
                                this.getRankColor(student.points)
                            } font-medieval">
                                ${this.getShortRankName(student.points)}
                            </span>
                        </td>
                        <td class="mobile-px-3 mobile-py-2">
                            <span class="mobile-px-2 mobile-py-1 rounded mobile-text-xs font-semibold border border-darkBrown ${
                                student.isOnline ? 'bg-forestGreen/20 text-forestGreen' : 'bg-deepRed/20 text-deepRed'
                            } font-medieval flex items-center">
                                <span class="online-status ${student.isOnline ? 'status-online' : 'status-offline'}"></span>
                                ${student.isOnline ? 'Online' : 'Offline'}
                            </span>
                        </td>
                        <td class="mobile-px-3 mobile-py-2">
                            <div class="flex flex-col space-y-1">
                                <button onclick="adminSystem.showAddPointsModal('${student.id}')" 
                                        class="bg-gold hover:bg-yellow-600 text-darkBrown mobile-px-2 mobile-py-1 rounded font-semibold transition-all duration-300 transform hover:scale-105 border border-darkBrown font-medieval mobile-text-xs flex items-center justify-center">
                                    <i class="fas fa-plus mr-1"></i>XP
                                </button>
                                <button onclick="adminSystem.resetStudent('${student.id}')" 
                                        class="bg-deepRed hover:bg-red-800 text-parchment mobile-px-2 mobile-py-1 rounded font-semibold transition-all duration-300 transform hover:scale-105 border border-gold font-medieval mobile-text-xs flex items-center justify-center">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            updateSearchInfo() {
                const searchInfo = document.getElementById('search-info');
                const resultCount = document.getElementById('result-count');
                const totalCount = document.getElementById('total-count');
                const searchTermDisplay = document.getElementById('search-term-display');

                if (this.searchTerm || this.selectedClass || this.selectedStatus !== 'all') {
                    resultCount.textContent = this.filteredStudents.length;
                    totalCount.textContent = this.students.length;
                    
                    let displayText = '';
                    if (this.searchTerm) {
                        displayText += ` untuk "${this.searchTerm}"`;
                    }
                    if (this.selectedClass) {
                        displayText += ` di ${this.selectedClass}`;
                    }
                    if (this.selectedStatus !== 'all') {
                        displayText += ` (${this.selectedStatus})`;
                    }
                    
                    searchTermDisplay.textContent = displayText;
                    searchInfo.classList.remove('hidden');
                } else {
                    searchInfo.classList.add('hidden');
                }
            }

            highlightSearchTerm(text) {
                if (!this.searchTerm) return text;
                
                const regex = new RegExp(`(${this.searchTerm})`, 'gi');
                return text.replace(regex, '<span class="search-highlight">$1</span>');
            }

            clearSearch() {
                document.getElementById('search-input').value = '';
                this.searchTerm = '';
                this.selectedClass = '';
                this.selectedStatus = 'all';
                this.updateFilterButtons();
                this.applyFilters();
            }

            filterByClass(className) {
                this.selectedClass = className;
                this.updateFilterButtons();
                this.applyFilters();
            }

            filterByStatus(status) {
                this.selectedStatus = status;
                this.updateFilterButtons();
                this.applyFilters();
            }

            updateFilterButtons() {
                // Remove active class from all buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Add active class to current class filter
                if (this.selectedClass === '') {
                    document.querySelector('.filter-btn:first-child').classList.add('active');
                } else {
                    const activeClassBtn = document.querySelector(`.filter-btn:contains("${this.selectedClass}")`);
                    if (activeClassBtn) {
                        activeClassBtn.classList.add('active');
                    }
                }

                // Add active class to current status filter
                if (this.selectedStatus === 'all') {
                    document.querySelectorAll('.filter-btn')[1].classList.add('active');
                } else if (this.selectedStatus === 'online') {
                    document.querySelectorAll('.filter-btn')[2].classList.add('active');
                } else if (this.selectedStatus === 'offline') {
                    document.querySelectorAll('.filter-btn')[3].classList.add('active');
                }
            }

            toggleSort() {
                this.sortDescending = !this.sortDescending;
                const sortIcon = document.getElementById('sort-icon');
                const sortText = document.getElementById('sort-text');
                
                if (this.sortDescending) {
                    sortIcon.className = 'fas fa-sort-amount-down mr-1';
                    sortText.textContent = 'XP Tertinggi';
                } else {
                    sortIcon.className = 'fas fa-sort-amount-up mr-1';
                    sortText.textContent = 'XP Terendah';
                }
                
                this.applyFilters();
            }

            // Method untuk menampilkan modal tambah point
            showAddPointsModal(studentId) {
                this.selectedStudentId = studentId;
                document.getElementById('points-amount').value = 5;
                document.getElementById('add-points-modal').classList.remove('hidden');
            }

            // Method untuk menambahkan point ke student tertentu - FIXED
            addPointsToStudent() {
                if (!this.selectedStudentId) {
                    this.showNotification('Tidak ada siswa yang dipilih', 'error');
                    return;
                }

                const points = parseInt(document.getElementById('points-amount').value) || 5;

                // Cari student berdasarkan ID
                const studentIndex = this.students.findIndex(s => s.id === this.selectedStudentId);
                
                if (studentIndex === -1) {
                    this.showNotification('Siswa tidak ditemukan', 'error');
                    return;
                }

                // Update data student
                this.students[studentIndex].points += points;
                this.students[studentIndex].lastActivity = new Date().toISOString();

                // FIXED: Simpan ke SATU storage utama
                this.saveChanges();
                this.closeAddPointsModal();
                
                const studentName = this.students[studentIndex].name;
                this.showNotification(`+${points} XP berhasil ditambahkan ke ${studentName}`, 'success');
            }

            showBulkAddModal(points) {
                this.bulkPoints = points;
                document.getElementById('bulk-points-amount').textContent = points;
                document.getElementById('bulk-add-modal').classList.remove('hidden');
            }

            addPointsToAllStudents() {
                const points = this.bulkPoints;
                
                this.students.forEach((student, index) => {
                    this.students[index].points += points;
                    this.students[index].lastActivity = new Date().toISOString();
                });

                this.saveChanges();
                this.closeBulkAddModal();
                this.showNotification(`+${points} XP ke semua petualang`, 'success');
            }

            resetStudent(studentId) {
                if (confirm('Reset XP petualang ini?')) {
                    const studentIndex = this.students.findIndex(s => s.id === studentId);
                    if (studentIndex !== -1) {
                        this.students[studentIndex].points = 0;
                        this.students[studentIndex].level = 0;
                        this.students[studentIndex].lastActivity = new Date().toISOString();
                        this.saveChanges();
                        this.showNotification(`XP ${this.students[studentIndex].name} direset`, 'info');
                    }
                }
            }

            saveChanges() {
                // FIXED: Simpan ke SATU storage utama saja
                localStorage.setItem('perpustakaan_abadi_students', JSON.stringify(this.students));
                this.applyFilters();
            }

            closeAddPointsModal() {
                document.getElementById('add-points-modal').classList.add('hidden');
                this.selectedStudentId = null;
            }

            closeBulkAddModal() {
                document.getElementById('bulk-add-modal').classList.add('hidden');
                this.bulkPoints = 0;
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 mobile-px-4 mobile-py-2 rounded-lg font-semibold text-white transition-all duration-300 transform translate-x-full border ${
                    type === 'error' ? 'bg-deepRed border-red-300' : 
                    type === 'success' ? 'bg-forestGreen border-green-300' : 'bg-mysticBlue border-blue-300'
                } font-medieval mobile-text-sm max-w-xs`;
                notification.textContent = message;

                document.body.appendChild(notification);

                setTimeout(() => notification.style.transform = 'translateX(0)', 100);

                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            getRankName(points) {
                if (points >= 1000) return 'ðŸ“• Penguasa Cerita';
                if (points >= 800) return 'ðŸ“— Ahli Tinta';
                if (points >= 600) return 'ðŸ“˜ Penjaga Buku';
                if (points >= 300) return 'ðŸ“œ Pencari Aksara';
                if (points >= 100) return 'ðŸ“š Penjelajah Halaman';
                return 'ðŸ“– Pemula Naskah';
            }

            getShortRankName(points) {
                if (points >= 1000) return 'ðŸ†';
                if (points >= 800) return 'ðŸ“—';
                if (points >= 600) return 'ðŸ“˜';
                if (points >= 300) return 'ðŸ“œ';
                if (points >= 100) return 'ðŸ“š';
                return 'ðŸ“–';
            }

            getRankColor(points) {
                if (points >= 1000) return 'bg-gradient-to-r from-red-500 to-yellow-500 text-white';
                if (points >= 800) return 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white';
                if (points >= 600) return 'bg-gradient-to-r from-purple-500 to-blue-500 text-white';
                if (points >= 300) return 'bg-gradient-to-r from-blue-500 to-green-500 text-white';
                if (points >= 100) return 'bg-gradient-to-r from-green-500 to-emerald-500 text-white';
                return 'bg-gradient-to-r from-gray-400 to-gray-600 text-white';
            }
        }

        // Global functions untuk modal
        function showBulkAddModal(points) {
            adminSystem.showBulkAddModal(points);
        }

        function closeAddPointsModal() {
            adminSystem.closeAddPointsModal();
        }

        function closeBulkAddModal() {
            adminSystem.closeBulkAddModal();
        }

        function addPointsToStudent() {
            adminSystem.addPointsToStudent();
        }

        function addPointsToAllStudents() {
            adminSystem.addPointsToAllStudents();
        }

        function refreshData() {
            adminSystem.loadStudents();
            adminSystem.showNotification('Data diperbarui', 'success');
        }

        // Initialize admin system
        const adminSystem = new AdminSystem();
    </script>
</body>
</html>
